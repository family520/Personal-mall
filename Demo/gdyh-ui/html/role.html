<!DOCTYPE html>
<html lang="zh">

	<head>
		<meta charset="utf-8">
		<link rel="shortcut icon" href="../images/logoIcon.png" type="image/icon" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
		<title>【光大银行】智慧综合管理系统</title>
		<link href="../css/bootstrap.min.css" rel="stylesheet">
		<link href="../css/font-awesome.min.css" rel="stylesheet">
		<link href="../css/materialdesignicons.min.css" rel="stylesheet">
		<link href="../css/style.min.css" rel="stylesheet">
		<link href="../plus/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
		<link href="../css/bootstrap-treeview.css" rel="stylesheet">
		<link href="../css/commonStyle.css" rel="stylesheet">
		<link rel="stylesheet" href="../css/bootstrap-select.css" />

		<script src="../js/jquery.min.js"></script>
		<script src="../js/bootstrap.min.js"></script>
		<script src="../js/bootstrap-select.js"></script>
		<script src="../plus/bootstrap-table/bootstrap-table.min.js"></script>
		<script src="../plus/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
		<script src="../plus/layer/layer.js"></script>
		<script src="../js/template-web.js"></script>
		<script src="../plus/validate/jquery.validate.min.js"></script>
		<script src="../plus/validate/messages_zh.min.js"></script>
		<script src="../js/bootstrap-treeview.js"></script>

		<script src="../js/httpUtils.js"></script>
		<script src="../js/Md5.js"></script>

		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=BLmvFHqpvs06ks32cjabm9ZldnvhFVBW"></script>
		<style type="text/css">
			.roleFooter {
				position: absolute;
				bottom: 0;
				width: 100%;
				left: 0;
			}

			#allmap {
				width: 745px;
				height: 455px;
				left: 0;
				top: 0;
				position: absolute;
				background-color: #FFFFFF;
			}
		</style>
	</head>

	<body>
		<div class="lyear-layout-web">
			<div class="lyear-layout-container">

				<!--加载头部和菜单栏-->
				<div id="hander">
					<script>
						$(function() {
							$("#hander").load("handMenu.html");
						});
					</script>
				</div>

				<!--页面主要内容-->
				<main class="lyear-layout-content" style="display: none">
					<div class="container-fluid">
						<div class="row">
							<div class="col-md-6">
								<div class="card">
									<div class="card-header">
										<h4>机构管理</h4>
									</div>
									<div class="card-body">
										<div class="ibox float-e-margins">
											<div class="ibox-content">
												<!--页面内容部分-->
												<div id="buttons">
													<button type="button" class="btn btn-primary" id="addOrg"><i class="fa fa-plus"></i>录入同级
                                            </button>
													<button type="button" class="btn btn-primary" id="addOrgDown"><i
                                                    class="fa fa-plus"></i> 录入下级
                                            </button>
													<button type="button" class="btn btn-info" id="editOrg"><i class="fa fa-edit"></i> 编辑
                                            </button>
													<button type="button" class="btn btn-danger" id="removeOrg"><i
                                                    class="fa fa-trash-o"></i> 删除
                                            </button>
                                            <button type="button" class="btn btn-primary" id="managerFloor"><i
                                                    class="fa fa-cog"></i> 管理楼层
                                            </button>
												</div>

												<div id="myTree" style="margin-top: 20px">

												</div>
											</div>

										</div>

									</div>
								</div>
							</div>
							<div class="col-md-6">
								<div class="card">
									<div class="card-header">
										<h4>角色管理</h4>
									</div>
									<div class="card-body">
										<div class="ibox float-e-margins">
											<div class="ibox-content">
												<!--页面内容部分-->
												<div class="buttons">
													<button type="button" class="btn btn-primary" id="addRole"><i class="fa fa-plus"></i>
                                                录入
                                            </button>
													<button type="button" class="btn btn-info" id="editRole"><i class="fa fa-edit"></i> 编辑
                                            </button>
													<button type="button" class="btn btn-danger" id="removeRole"><i
                                                    class="fa fa-trash-o"></i> 删除
                                            </button>
													<button type="button" class="btn btn-warning" id="getAuthor"><i
                                                    class="fa fa-warning"></i>
                                                权限配置
                                            </button>
												</div>
												<div id="myTable">

												</div>
											</div>
										</div>

									</div>
								</div>
							</div>
						</div>
					</div>
				</main>
				<!--End 页面主要内容-->
			</div>
		</div>
		<!--加载底部-->
		<div id="footer" class="roleFooter">
			<script type="text/javascript">
				$(function() {
					$("#footer").load("footer.html");
				});
			</script>
		</div>
		<div id="loadDiv"></div>

		<script>
			var html;
		</script>
		<script>
			$("#loadDiv").html(loadHtml);
			var organization_option = function() {
				return {
					node: $("#myTree"), //渲染节点
					data: "", //机构数据
					init: function() {
						var that = this;
						var options = {
							checkedIcon: "glyphicon glyphicon-check",
							nodeIcon: "none", //所有节点的默认图标
							levels: 5,
							data: this.data,
							onhoverColor: "rgba(0,0,0,0.1)",
							onNodeSelected: function(event, data) {
								var data = that.node.treeview('getSelected');
								roleTable.refresh();
								//todo 需要刷新角色页面
							}
						};
						this.node.treeview(options);
					},

					initData: function() {
						var _this = this;
						//if(this.data == "") {
						$.sanjiGetJSON(userServiceUrl + "/organization/treeList", {isScreenOrganization:1}, function(data) {
							_this.data = _this.getTreeData(data.data);
							_this.init();
						});
						//return;
						//}
						//_this.init();
					},
					getSelectedVal: function() {
						//console.log(111);
						var data = this.node.treeview('getSelected');
						//console.log(data.nodeType)
						//todo 需要刷新角色页面
						//console.log(data);
						return data;
					},
					getTreeData: function(data) {
						var rdata = [];
						if(data==null){
							return rdata;
						}
						for(var i = 0; i < data.length; i++) {
							var node = data[i];
							var one = {};
							one.text = node.organizationName;
							one.parentIds = node.parentId;
							one.organizationName = node.organizationName;
							one.organizationDescription = node.organizationDescription;
							one.organizationDuty = node.organizationDuty;
							one.organizationDutycell = node.organizationDutycell;
							one.organizationLongitude = node.organizationLongitude;
							one.organizationLatitude = node.organizationLatitude;
							one.id = node.id;
							if(node.childrens != undefined && node.childrens != null && node.childrens != '') {
								one.nodes = this.getTreeData(node.childrens);
							}
							rdata.push(one);
						}
						return rdata;
					},
					bindCreate: function() {
						var that = this;
						$("#addOrg").on("click", function() {
							/*var data = that.node.treeview('getSelected');
							if(data.length == 1) {
								that.showOrgModel("添加组织机构", 1);
							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}*/



                            /*返回所有被选择节点的数组*/
                            var data = $("#myTree").treeview('getSelected');
                            /*返回所有没有选择节点的数组*/
                            var data1 = $("#myTree").treeview('getUnselected');
                            if (data.length == 0 && data1.length == 0) {
                                that.showOrgModel("添加同级组织机构", 4);

                            } else if (data.length == 1) {
                                that.showOrgModel("添加同级组织机构", 1);

                            } else {
                                layer.msg("请选择一条数据", {
                                    icon: 5
                                });
                            }
						});
						$("#addOrgDown").on("click", function() {
							var data = that.node.treeview('getSelected');
							if(data.length == 1) {

								if(data[0].parentIds == 0){
									that.showOrgModel("添加组织机构", 3);

								}else{
									layer.msg("该支行下不能添加支行", {
										icon: 5
									});
								}

							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}
						});

						$("#editOrg").on("click", function() {
							var data = that.node.treeview('getSelected');
							if(data.length == 1) {
								that.showOrgModel("修改组织机构", 2);
							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}
						});

						$("#removeOrg").on("click", function() {
							var data = that.node.treeview('getSelected');
							if(data.length == 1) {
								var conlayer = layer.confirm("确定删除？", {
									btn: ['确定', '取消']
								}, function() {
									$.show_overall_loding();
									$.deleteJSON(userServiceUrl + "/organization?id=" + data[0].id, {}, function(data) {
										$.hide_overall_loding();
										if(data.code == 0) {
											layer.close(conlayer);
											layer.msg("成功", {
												icon: 1
											});
											that.initData();
											return true;
										}
										layer.msg("操作失败", {
											icon: 2
										});
									})
								}, function() {
									layer.close(conlayer);
								});
							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}
						});

						$("#managerFloor").on("click", function() {
							var data = that.node.treeview('getSelected');
							if(data.length == 1) {
								that.showFloorModel("管理楼层", data[0].id);
							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}
						});


					},
					showOrgModel: function(title, flag, index) {
						var that = this;
						var isAdd = true;
						var isDown = false;
						if(flag == 2) {
							isAdd = false;
						}
						if(flag == 3) {
							isDown = true;
						}
						html = template("modelOrg", {
							title: "123"
						});
						var myLayer = layer.open({
							skin: 'card',
							type: 1,
							title: title,
							area: ['700px', '350px'], //宽高
							resize: true, //是否拉升
							offset: 'auto', //居中
							content: html,
							btn: ['提交', '取消'],
							yes: function(index, layero) {
								$("#orgForm").submit();
							},
							success: function(layero) {
								var data = that.node.treeview('getSelected');
								if(flag == 2) {
									$("#orgForm").setForm(data[0]);
								}

								$("#showMap").click(function() {
										showMap(data[0].organizationLongitude, data[0].organizationLatitude);
									});
							}
						});
						var validate = $("#orgForm").validate({
							rules: {
								organizationName: {
									required: true
								},
								organizationDescription: {
									required: true
								},
								organizationDuty: {
									required: true
								},
								organizationDutycell: {
									required: true
								},
								organizationLongitude: {
									required: true
								},
								organizationLatitude: {
									required: true
								}
							},
							messages: {
								organizationName: {
									required: "请输入组织机构名称"
								},
								organizationDescription: {
									required: "请输入组织机构描述"
								},
								organizationDuty: {
									required: "请输入负责人"
								},
								organizationDutycell: {
									required: "请输入联系电话"
								},
								organizationLongitude: {
									required: "请输入经度"
								},
								organizationLatitude: {
									required: "请输入纬度"
								}
							},
							submitHandler: function(form) {
								var oldData = that.node.treeview('getSelected');
								var data = $("#orgForm").serializeJson()
								var organizationName = $("#organizationName").val();
                                /*返回所有被选择节点的数组*/
                                var dataJudge = $("#myTree").treeview('getSelected');
                                /*返回所有没有选择节点的数组*/
                                var dataJudge1 = $("#myTree").treeview('getUnselected');
								if(isDown) {
									$.extend(data, {
										"parentId": oldData[0].id
									});
								} else {
                                    if(dataJudge.length == 0 && dataJudge1.length == 0){
                                        $.extend(data, {
                                            "parentId": 0
                                        });
                                    } else {
                                        $.extend(data, {
                                            "parentId": oldData[0].parentIds,
                                        });
                                    }
								}
								$.show_overall_loding();
								if(isAdd) {
									$.postJSON(userServiceUrl + "/organization", data, function(data) {
										$.hide_overall_loding();
										if(data.code == 0) {
											layer.close(myLayer);
											layer.msg("成功", {
												icon: 1
											});
											that.initData();
											return true;
										}
										layer.msg("操作失败", {
											icon: 2
										});
									});
								} else {
									$.putJSON(userServiceUrl + "/organization", data, function(data) {
										$.hide_overall_loding();
										if(data.code == 0) {
											layer.close(myLayer);
											layer.msg("成功", {
												icon: 1
											});
											that.initData();
											return true;
										}
										layer.msg("操作失败", {
											icon: 2
										});
									});
								}
							}
						});
					},

//					showFloorModel: function(title, organizationId, index){
//						var that = this;
//
//						html = template("floorModel", {title: "123"});
//
//						var myLayer = layer.open({
//				            skin: 'card',
//				            type: 1,
//				            title: "管理楼层",
//				            area: ['300px','150px'],	        //宽高
//				            resize: true,				//是否拉升
//				            offset: 'auto',				//居中
//				            content: html,
//				            success: function (layero) {
//
//				            	$("#addFloorBtn").on("click", function() {
//										that.showAddFloorModel("添加楼层", organizationId);
//								});
//
//								$("#removeFloorBtn").on("click", function() {
//										that.showDelFloorModel("删除楼层", organizationId);
//								});
//
//				            }
//				        });
//					},

					showFloorModel: function(title, organizationId, index){

						html = template("floorModel", {title: "123"});

						var myLayer = layer.open({
				            skin: 'card',
				            type: 1,
				            title: "管理楼层",
				            area: ['700px','500px'],	        //宽高
				            resize: true,				//是否拉升
				            offset: 'auto',				//居中
				            content: html,
				            success: function (layero) {
				            	var floorTable = new floorTable_option();
								floorTable.init();
								floorTable.bindCreate();

				            }
				        });
					}
				}
			}
			var organization = new organization_option();
			organization.initData();
			organization.bindCreate();



			var lat = "";
			var lng = "";

			function showMap(deviceLongitude, deviceLatitude) {
				var myLayer = layer.open({
					skin: 'card', //自定义样式winning-class
					title: "选择经纬度",
					area: ['750px', '540px'],
					resize: true, //是否拉升
					offset: 'auto', //居中
					content: template("modelMap", {
						title: "123"
					}),
					btn: ['提交', '取消'],
					yes: function(index, layero) {
						$("#organizationLatitude").val(lat);
						$("#organizationLongitude").val(lng);
						layer.close(myLayer);

					},
					success: function(layero) {
						map = new BMap.Map("allmap");
						map.centerAndZoom(new BMap.Point(116.331398, 39.897445), 11);
						map.enableScrollWheelZoom(true);
						if(deviceLatitude && deviceLongitude) {
							map.clearOverlays();
							var new_point = new BMap.Point(deviceLongitude, deviceLatitude);
							var marker = new BMap.Marker(new_point, 10); // 创建标注
							map.addOverlay(marker); // 将标注添加到地图中
							map.panTo(new_point);
						}

						function showInfo(e) {
							map.clearOverlays();
							var new_point = new BMap.Point(e.point.lng, e.point.lat);
							var marker = new BMap.Marker(new_point, 50); // 创建标注
							map.addOverlay(marker); // 将标注添加到地图中
							lat = e.point.lat;
							lng = e.point.lng;
						}
						map.addEventListener("click", showInfo);
						// 添加带有定位的导航控件
						var navigationControl = new BMap.NavigationControl({
							// 靠左上角位置
							anchor: BMAP_ANCHOR_TOP_LEFT,
							// LARGE类型
							type: BMAP_NAVIGATION_CONTROL_LARGE,
							// 启用显示定位
							enableGeolocation: true
						});
						map.addControl(navigationControl);
						// 添加定位控件
						var geolocationControl = new BMap.GeolocationControl();
						geolocationControl.addEventListener("locationSuccess", function(e) {
							// 定位成功事件
							var address = '';
							address += e.addressComponent.province;
							address += e.addressComponent.city;
							address += e.addressComponent.district;
							address += e.addressComponent.street;
							address += e.addressComponent.streetNumber;
						});
						geolocationControl.addEventListener("locationError", function(e) {
							// 定位失败事件
							layer.msg("定位失败", {
								icon: 2
							});
						});
						map.addControl(geolocationControl);
					}
				})
			}
		</script>

		<script>
			var floorTable_option = function() {
				return {
					node: $('#myFloorTable'),
					init: function() {
						$.show_overall_loding();
						var that = this;
						this.node.bootstrapTable({
							url: userServiceUrl + "/floor/list",
							method: 'get', //请求方式（*）
							contentType: "application/x-www-form-urlencoded",
							toolbar: '', //工具按钮用哪个容器
							striped: true, //是否显示行间隔色
							cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
							pagination: true, //是否显示分页（*）
							sortable: false, //是否启用排序
							sidePagination: "server", //分页方式：client客户端分页，server服务端分页（*）
							pageNumber: 1, //初始化加载第一页，默认第一页
							pageSize: 10, //每页的记录行数（*）
							pageList: [10, 25, 50, 100], //可供选择的每页的行数（*）
							queryParamsType: '',
							queryParams: that.queryParams, //传递参数（*）
							strictSearch: true,
							uniqueId: "id", //每一行的唯一标识，一般为主键列
							cardView: false, //是否显示详细视图
							detailView: false, //是否显示父子表
							clickToSelect: true, //点击行是否选中
							responseHandler: function(data) {
								var res = [];
								if(data.code == 0) {
									var result = data.data;
									res.push({
										total: result.total,
										rows: result.list
									});
									return res[0];
								} else {
									res.push({
										total: 0,
										rows: null
									});
									return res[0];
								}
							},
							onLoadSuccess: function() {

								$.hide_overall_loding();
							},
							onDblClickRow: function(row) {
								console.info(row);
							},
							columns: [{
								checkbox: true
							}, {
								width: 50,
								title: '序号',
								formatter: function(value, row, index) {
									return index + 1;
								}
							}, {
								field: 'name',
								title: '楼层名称',
								width: 300
							}, {
								field: 'imgUrl',
								title: '楼层平面图',
								width: 300,
								formatter:function(value, row, index){
				                    if(value == null){
				                        return "-";
				                    }else{
				                        let str = '<img src="'+ value + '" style="height: 40px;width: 80px;" />';
				                        return str;
				                    }
				                }
							}]
						});
					},
					queryParams: function(params) {
						//console.log(params);
						$.show_overall_loding();
						var data = {
							token: $.getToken(),
							pageSize: params.pageSize,
							pageNum: params.pageNumber
						}
						var organizationData = organization.getSelectedVal();
						if(organizationData.length > 0 && organizationData[0].id != "myTree") {
							$.extend(data, {
								"organizationId": organizationData[0].id
							});
						}else{
								$.extend(data, {
								"organizationId": 9999
							});
						}
						return data;
					},
					refresh: function() {
						$.show_overall_loding();
						this.node.bootstrapTable('refresh')
					},
					getSelectVal: function() {
						var data = this.node.bootstrapTable('getSelections');
						return data[0];
					},
					bindCreate: function() {
						var that = this;

						$("#removeFloor").on("click", function() {
							var data = that.node.bootstrapTable('getSelections');
							if(data.length == 1) {
								var conlayer = layer.confirm("确定删除？", {
									btn: ['确定', '取消']
								}, function() {
									$.show_overall_loding();
									$.deleteJSON(userServiceUrl + "/floor/delFloor?id=" + data[0].id, {}, function(data) {
										$.hide_overall_loding();
										if(data.code == 0) {
											layer.close(conlayer);
											layer.msg("成功", {
												icon: 1
											});
											$('#myFloorTable').bootstrapTable('refresh');
											return true;
										}
										layer.msg("操作失败", {
											icon: 2
										});
									})
								}, function() {
									layer.close(conlayer);
								});
							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}
						});

						$("#addFloor").on("click", function() {
							that.showAddFloorModel("添加楼层", 1);
						});
						$("#editFloor").on("click", function() {
							var data = that.node.bootstrapTable('getSelections');
							if(data.length == 1) {
								url = "";
								that.showAddFloorModel("修改楼层", 2);
							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}
						});
					},
					showAddFloorModel: function(title, flag, index){
						var that = this;
						var isAdd = true;
						if(flag == 1) {
							isAdd = true;
						} else {
							isAdd = false;
						}

				        html = template("addFloorModel", {title: "123"});


				        var myLayer = layer.open({
				            skin: 'card',
				            type: 1,
				            title: title,
				            area: ['400px','330px'],	        //宽高
				            resize: true,				//是否拉升
				            offset: 'auto',				//居中
				            content: html,
				            btn: ['提交', '取消'],
				            yes: function (index, layero) {
				                $("#floorForm").submit();
				            },
				            success: function (layero) {
				            	if(flag == 1) {
				            		var data = organization.getSelectedVal();
				            		$("#organizationId").attr("value",data[0].id);
				            	}else if(flag == 2) {
				            		var data = that.node.bootstrapTable('getSelections');

				            		if(data[0].imgUrl != null){
					                    $("#imgUrl").css("display","block");
					                }

				            		$("#imgUrl").attr("src",data[0].imgUrl);
				            		$("#imgUrlAdd").attr("value",data[0].imgUrl);
				            		$("#name").attr("value",data[0].name);
				            		$("#floorId").attr("value",data[0].id);
								}
				            }
				        });
				        //validata开始
				        var validate = $("#floorForm").validate({
				            rules: {
				            	name: {
									required: true
								},
				            },
				            messages: {
				            	name: {
									required: "请输入楼层名称"
								},
				            },
				            submitHandler: function (form) {
				                let floorName = $("#name").val();
				                let id = $("#floorId").val();
				                let organizationId = $("#organizationId").val();
				                let imgUrl = $("#imgUrlAdd").val();

				                $.show_overall_loding();
				                if(isAdd) {
					                $.postJSON(userServiceUrl + "/floor/addFloor",{organizationId:organizationId,imgUrl:imgUrl,name:floorName},function (resData) {
		                                if(resData.code == 0){
		                                    layer.close(myLayer);
		                                    layer.msg("成功", {icon: 1});
		                                    $('#myFloorTable').bootstrapTable('refresh');
											return true;
		                                }else{
		                                    layer.msg("操作失败", {icon: 2});
		                                }
		                            })
					            }else{
					            	$.putJSON(userServiceUrl + "/floor",{id:id,imgUrl:imgUrl,name:floorName},function (resData) {
		                                if(resData.code == 0){
		                                    layer.close(myLayer);
		                                    layer.msg("成功", {icon: 1});
		                                    $('#myFloorTable').bootstrapTable('refresh');
											return true;
		                                }else{
		                                    layer.msg("操作失败", {icon: 2});
		                                }
		                            })
					            }
				            }
				        });
				        //validata结束
				    }
				}
			}



		</script>
		<script>
			var roleTable_option = function() {
				return {
					node: $('#myTable'),
					init: function() {
						$.show_overall_loding();
						var that = this;
						this.node.bootstrapTable({
							url: userServiceUrl + "/role/list",
							//data: tableData, //本地数据
							method: 'get', //请求方式（*）
							contentType: "application/x-www-form-urlencoded",
							toolbar: '', //工具按钮用哪个容器
							striped: true, //是否显示行间隔色
							cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
							pagination: true, //是否显示分页（*）
							sortable: false, //是否启用排序
							sidePagination: "server", //分页方式：client客户端分页，server服务端分页（*）
							pageNumber: 1, //初始化加载第一页，默认第一页
							pageSize: 10, //每页的记录行数（*）
							pageList: [10, 25, 50, 100], //可供选择的每页的行数（*）
							queryParamsType: '',
							queryParams: that.queryParams, //传递参数（*）
							strictSearch: true,
							uniqueId: "id", //每一行的唯一标识，一般为主键列
							cardView: false, //是否显示详细视图
							detailView: false, //是否显示父子表
							clickToSelect: true, //点击行是否选中
							responseHandler: function(data) {
								var res = [];
								if(data.code == 0) {
									var result = data.data;
									res.push({
										total: result.total,
										rows: result.list
									});
									return res[0];
								} else {
									res.push({
										total: 0,
										rows: null
									});
									return res[0];
								}
							},
							onLoadSuccess: function() {
								//					$('.dropdown-toggle').on("click", function() {
								//						// $('.dropdown-toggle').parent().toggleClass("open");
								//					});

								$.hide_overall_loding();
							},
							onDblClickRow: function(row) {
								console.info(row);
							},
							columns: [{
								checkbox: true
							}, {
								width: 50,
								title: '序号',
								formatter: function(value, row, index) {
									return index + 1;
								}
							}, {
								field: 'roleName',
								title: '角色名称',
								width: 300
							}, {
								field: 'roleDescription',
								title: '角色描述',
								width: 500
							}, {
								field: 'createDate',
								title: '创建时间',
								width: 300
							}]
						});
					},
					queryParams: function(params) {
						//console.log(params);
						$.show_overall_loding();
						var data = {
							token: $.getToken(),
							pageSize: params.pageSize,
							pageNum: params.pageNumber
						}
						//console.log(organization.node);
						var organizationData = organization.getSelectedVal();
						//console.log(organizationData);
						if(organizationData.length > 0 && organizationData[0].id != "myTree") {
							$.extend(data, {
								"organizationId": organizationData[0].id
							});
						}else{
								$.extend(data, {
								"organizationId": 9999
							});
						}
						return data;
					},
					refresh: function() {
						$.show_overall_loding();
						this.node.bootstrapTable('refresh')
					},
					getSelectVal: function() {
						var data = this.node.bootstrapTable('getSelections');
						return data[0];
					},
					bindCreate: function() {
						var that = this;
						$("#addRole").on("click", function() {
							var data = organization.getSelectedVal();
							if(data.length < 1) {
								layer.msg("请先选择机构再添加", {
									icon: 5
								});
								return;
							}
							that.showRoleModel("添加角色", 1);
						});

						$("#editRole").on("click", function() {
							var data = that.node.bootstrapTable('getSelections');
							if(data.length == 1) {
								url = "";
								that.showRoleModel("修改角色", 2);
							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}
						});

						$("#getAuthor").on("click", function() {
							var data = that.node.bootstrapTable('getSelections');
							if(data.length == 1) {
								authorTree.showAuthorModel();
							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}
						});

						$("#removeRole").on("click", function() {
							var data = that.node.bootstrapTable('getSelections');
							if(data.length == 1) {
								var conlayer = layer.confirm("确定删除？", {
									btn: ['确定', '取消']
								}, function() {
									$.show_overall_loding();
									$.deleteJSON(userServiceUrl + "/role?id=" + data[0].id, {}, function(data) {
										$.hide_overall_loding();
										if(data.code == 0) {
											layer.close(conlayer);
											layer.msg("成功", {
												icon: 1
											});
											$('#myTable').bootstrapTable('refresh');
											return true;
										}
										layer.msg("操作失败", {
											icon: 2
										});
									})
								}, function() {
									layer.close(conlayer);
								});
							} else {
								layer.msg("请选择一条数据", {
									icon: 5
								});
							}
						});
					},
					showRoleModel: function(title, flag, index) {
						var that = this;
						if(flag == 1) {
							isAdd = true;
						} else {
							isAdd = false;
						}
						html = template("modelRole", {
							title: "123"
						});
						var myLayer = layer.open({
							skin: 'card',
							type: 1,
							title: title,
							area: ['500px', '320px'], //宽高
							resize: true, //是否拉升
							offset: 'auto', //居中
							content: html,
							btn: ['提交', '取消'],
							yes: function(index, layero) {
								$("#roleForm").submit();
							},
							success: function(layero) {
								if(flag == 2) {
									var data = $("#myTable").bootstrapTable('getSelections')[0];
									$("#roleForm").setForm(data);
								}
							}
						});
						var validate = $("#roleForm").validate({
							rules: {
								roleName: {
									required: true
								},
								roleDescription: {
									required: true
								}
							},
							messages: {
								roleName: {
									required: "请输入用户名称"
								},
								roleDescription: {
									required: "请输入登录名称"
								}
							},
							submitHandler: function(form) {
								//								var userName = $("#userName").val();
								//								var loginName = $("#loginName").val();
								//								var userMoble = $("#userMoble").val();
								//								var userEmail = $("#userEmail").val();
								var data = $("#roleForm").serializeJson();
								var organizationData = organization.getSelectedVal();
								if(organizationData.length > 0 && organizationData[0].id != "myTree") {
									$.extend(data, {
										"organizationId": organizationData[0].id
									});
								}
								//console.log(isAdd);
								$.show_overall_loding();
								if(isAdd) {
									$.postJSON(userServiceUrl + "/role", data, function(data) {
										$.hide_overall_loding();
										if(data.code == 0) {
											layer.close(myLayer);
											layer.msg("成功", {
												icon: 1
											});
											that.node.bootstrapTable('refresh');
											return true;
										}
										layer.msg("操作失败", {
											icon: 2
										});
									});
								} else {
									$.putJSON(userServiceUrl + "/role", data, function(data) {
										$.hide_overall_loding();
										if(data.code == 0) {
											layer.close(myLayer);
											layer.msg("成功", {
												icon: 1
											});
											that.node.bootstrapTable('refresh');
											return true;
										}
										layer.msg("操作失败", {
											icon: 2
										});
									});
								}
							}
						});
					}
				}
			}

			var roleTable = new roleTable_option();
			roleTable.init();
			roleTable.bindCreate();

			var author = function() {
				return {
					node: $("#authorityTree"), //借点
					data: "", //数据
					init: function() {
						var that = this;
						if(that.data == "") {
							$.sanjiGetJSON(userServiceUrl + "/user/menuTree", {isMenu:"1"}, function(data) {
								that.data = that.getTreeData(data.data);
								that.initData();
							});
							return true;
						}
						that.initData();
					},
					initData: function() {
						var that = this;
						that.node.treeview({
							data: that.data,
							levels: 2,
							showCheckbox: true,
							onNodeChecked: function(event, node) { //选中节点
								var selectNodes = getChildNodeIdArr(node); //获取所有子节点
								if(selectNodes) { //子节点不为空，则选中所有子节点
									that.node.treeview('checkNode', [selectNodes, {
										silent: true
									}]);
								}
								if(node.parentId || node.parentId == "0") {
									that.node.treeview('checkNode', [node.parentId, {
										silent: true
									}]);
								}
							},
							onNodeUnchecked: function(event, node) { //取消选中节点
								// 取消父节点 子节点取消
								var selectNodes = setChildNodeUncheck(node); //获取未被选中的子节点
								var childNodes = getChildNodeIdArr(node); //获取所有子节点
								var parentNode = that.node.treeview("getNode", node.parentId);
								if(childNodes) { //有子节点且未被选中的子节点数目为0，则取消选中所有子节点
									//console.log("反选");
									that.node.treeview('uncheckNode', [childNodes, {
										silent: true
									}]);
								}
								if((node.parentId || node.parentId =="0") && parentNode) {
									let paSelectNodes = setChildNodeUncheck(parentNode);
									let paChildNodes = getChildNodeIdArr(parentNode);
									if(paSelectNodes.length == paChildNodes.length) {
										that.node.treeview('uncheckNode', [node.parentId, {
											silent: true
										}]);
									}
								}
							}
						});

						var role = roleTable.getSelectVal();
							$.show_overall_loding();
						$.sanjiGetJSON(userServiceUrl + "/role/getAuthority?roleId=" + role.id, {}, function(data) {
								$.hide_overall_loding();
							if(data.code == 0) {
								var list = data.data;
								var thatNode = that.node.treeview("getUnselected");
								for(var i = 0; i < thatNode.length; i++) {
									if(list.indexOf(thatNode[i].id) >= 0) {
										that.node.treeview("checkNode", [thatNode[i].nodeId, {
											silent: true
										}]);
									}
								}

								//                      	for (var i=0;i<list.length;i++) {
								//                      		var node=list[i];
								//                      		 console.log(node);
								//
								//                      		 console.log(thatNode);
								//                      		 that.node.treeview("checkNode", [thatNode.nodeId, {
								//		                            silent: true
								//		                       	 }]);
								//                      	}

								//                      that.node.treeview('selectNode', [1, {
								//                          silent: true
								//                     	 }]);
							}
						});

					},
					//          getTreeData: function(data) {
					//              for(var i = 0; i < data.length; i++) {
					//                  var node = data[i];
					//                  var one = {};
					//                  one.text = node.authorityName;
					//                  one.id = node.id;
					//                  one.state['checked'] = true;
					//                  if(node.childrens != undefined && node.childrens != null && node.childrens != '') {
					//                      one.nodes = this.getTreeData(node.childrens);
					//                  }
					//                  rdata.push(one);
					//              }
					//              return rdata;
					//          },
					getTreeData: function(data) {
						var rdata = [];
						for(var i = 0; i < data.length; i++) {
							var node = data[i];
							var one = {};
							one.text = node.authorityName;
							one.id = node.id;
							one.nodeId = node.id;
							if(node.childrens != undefined && node.childrens != null && node.childrens != '') {
								one.nodes = this.getTreeData(node.childrens);
							}
							rdata.push(one);
						}
						return rdata;
					},
					showAuthorModel: function() {
						var that = this;
						var _html = template("modelTree", {
							title: "123"
						});
						var authlayer = layer.open({
							type: 1,
							title: '菜单权限配置',
							closeBtn: 1,
							shade: false,
							moveType: 0, //拖拽模式，0或者1
							maxWidth: 500,
							zIndex: layer.zIndex,
							content: _html,
							area: ['500px', '500px'],
							offset: 'auto',
							btn: ['提交', '取消'],
							yes: function(index, layero) {
								var authorarr = that.node.treeview("getChecked");
								var authids = [];
								for(var i in authorarr) {
									authids.push(authorarr[i].id);
								}
								var role = roleTable.getSelectVal();
								var data = {};
								data.authorityIds = authids;
								data.roleId = role.id;
								$.show_overall_loding();
								$.postJSON(userServiceUrl + "/role/addAuthority", data, function(data) {
									$.hide_overall_loding();
									if(data.code == 0) {
										layer.close(authlayer);
										layer.msg("成功", {
											icon: 1
										});
										//roleTable.bootstrapTable('refresh');
										return true;
									}
									layer.msg("操作失败", {
										icon: 2
									});
								});
							},
							success: function(layero) {
								that.node = layero.find("#authorityTree");
								that.init();
							}
						});
					}
				}
			}

			var authorTree = new author();

			// authorTree.init();

			function getChildNodeIdArr(node) {
				var ts = [];
				if(node.nodes) {
					for(x in node.nodes) {
						ts.push(node.nodes[x].nodeId);
						if(node.nodes[x].nodes) {
							var getNodeDieDai = getChildNodeIdArr(node.nodes[x]);
							for(j in getNodeDieDai) {
								ts.push(getNodeDieDai[j]);
							}
						}
					}
				} else {
					ts.push(node.nodeId);
				}
				return ts;
			}

			// 取消父节点时 取消所有子节点
			function setChildNodeUncheck(node) {
				if(node.nodes) {
					var ts = []; //当前节点子集中未被选中的集合
					for(x in node.nodes) {
						if(!node.nodes[x].state.checked) {
							ts.push(node.nodes[x].nodeId);
						}
						if(node.nodes[x].nodes) {
							var getNodeDieDai = node.nodes[x];
							for(j in getNodeDieDai) {

								if(!getNodeDieDai.state.checked) {
									ts.push(getNodeDieDai[j]);
								}
							}
						}
					}
				}
				return ts;
			}

		</script>

		<!--权限新增修改模板-->
		<script type="text/html" id="modelOrg">
			<section class="openDetail" style="width: 100%;">
				<div class="panel-body">
					<form id="orgForm">
						<div class="row">
							<div class="col-lg-6 MarginPx">
								<label class="layui-form-label">网点名称：</label>
								<div class="layui-input-block">
									<input  class="form-control" id="organizationName" name="organizationName" type="text">
								</div>
							</div>
							<div class="col-lg-6 MarginPx">
								<label class="layui-form-label">网点描述：</label>
								<div class="layui-input-block">
									<input  class="form-control" id="organizationDescription" name="organizationDescription" type="text">
								</div>
							</div>
							<div class="col-lg-6 MarginPx">
								<label class="layui-form-label">负责人：</label>
								<div class="layui-input-block">
									<input  class="form-control" id="organizationDuty" name="organizationDuty" type="text">
								</div>
							</div>
							<div class="col-lg-6 MarginPx">
								<label class="layui-form-label">联系电话：</label>
								<div class="layui-input-block">
									<input class="form-control" id="organizationDutycell" name="organizationDutycell" type="text">
								</div>
							</div>
							<div class="col-lg-6 MarginPx">
								<label class="layui-form-label">支行经度:</label>
								<div class="layui-input-block">
									<input class="form-control" id="organizationLongitude" name="organizationLongitude" type="text">
								</div>
							</div>
							<div class="col-lg-6 MarginPx">
								<label class="layui-form-label">支行纬度:</label>
								<div class="layui-input-block">
									<input class="form-control" id="organizationLatitude" name="organizationLatitude" type="text">
								</div>
							</div>
							<div class="col-lg-12 MarginPx isShows">
								<label class="layui-form-label">地图定点:</label>
								<div class="layui-input-block">
									<button style="width: 180px;" type="button" class="btn btn-success" id="showMap"><i class="fa fa-map"></i> 选择经纬度</button>
								</div>
							</div>

						</div>
						<!--<div style="text-align: center;margin-top: 50px;">
            <button class="btn btn-success" type="submit" style="padding: 10px 50px">提交</button>
        </div>-->

						<input type="hidden" id="orgId" name="id" />
					</form>
				</div>
			</section>
		</script>
		<!--角色新增修改模板-->
		<script type="text/html" id="modelRole">
			<section class="openDetail" style="width: 100%;">
				<div class="panel-body">
					<form id="roleForm">
						<div class="row">
							<div class="col-lg-12" style="margin: 20px 0;">
								<label class="layui-form-label">角色名称：</label>
								<input style="width: 70%;" class="form-control" id="roleName" name="roleName" type="text">
							</div>
							<div class="col-lg-12" style="margin: 20px 0;">
								<label class="layui-form-label">角色描述：</label>
								<input style="width: 70%;" class="form-control" id="roleDescription" name="roleDescription" type="text">
							</div>
						</div>
						<!--<div class="form-group" style="margin-bottom: 0px;">
            <label>所属组织机构：</label>
            <input class="form-control" id="organization" name="organization" type="text"
                   onclick="$('#myTree').show();" readonly style="cursor: pointer;background-color: #fff;">
            <input type="hidden" id="organizationId" name="organizationId" value="">
        </div>
        <div id="myTree" style="display:none;"></div>-->
						<div class="clearfix" style="margin-bottom: 15px;"></div>
						<input type="hidden" id="roleId" name="id" />
					</form>
				</div>
			</section>
		</script>

		<!--菜单权限配置模板-->
		<script type="text/html" id="modelTree">
			<section class="openDetail" style="width: 100%;height:100%">
				<div>
					<div class="panel-body">
						<div id="authorityTree" style="width: 450px;"></div>
					</div>
				</div>
			</section>
		</script>

		<!--显示地图-->
		<script type="text/html" id="modelMap">
			<div id="allmap"></div>
		</script>

		<script type="text/html" id="floorModel">
			<div class="card" style="border: 1px solid rgba(77,82,89,0.05); width: 95%;margin: auto;">
				<div class="card-header">
					<h4>管理楼层</h4>
				</div>
				<div class="card-body">
					<!--Start-->
					<!--平台楼层列表-->
					<div class="buttons">
								<button type="button" class="btn btn-primary" id="addFloor"><i
                                class="fa fa-plus"></i> 新增
                        </button>
								<button type="button" class="btn btn-info" id="editFloor"><i
                                class="fa fa-trash-o"></i> 编辑
                        </button>
                        		<button type="button" class="btn btn-danger" id="removeFloor"><i
                                class="fa fa-trash-o"></i> 删除
                        </button>
					</div>
					<div id="myFloorTable"></div>
				</div>
			</div>
		</script>

		<!--新增/修改楼层模板-->
		<script type="text/html" id="addFloorModel">
		    <section class="openDetail" style="width: 100%;text-align: center">
		        <div class="panel-body">
		            <form class="form-horizontal" id="floorForm">
		            	<input type="hidden" id="floorId" name="id" />
		            	<input type="hidden" id="imgUrlAdd" name="imgUrl" />
		            	<input type="hidden" name="organizationId" id="organizationId"/>
		                <div class="form-group">
		                    <label for="name" class="col-sm-5 control-label">楼层名称：</label>
		                    <div class="col-sm-7">
		                        <input type="text" class="form-control" id="name" name="name" >
		                    </div>
		                </div>
		                <div class="form-group">
		                    <label for="imgUrl" class="col-sm-5 control-label">楼层二维图片：</label>
		                    <div class="col-sm-7">
		                        <div id="imgPreview">
		                            <span id="imgSpan">
		                            </span>
		                            <img src="" id="imgUrl" />
		                        </div>
		                    </div>
		                    <input type="file"  id="file" accept="image/jpg,image/jpeg,image/png,image/PNG" onchange="getPic()" value="" style="display: none" />
		                </div>
		            </form>
		            <button style="width: 90px;" onclick="triggerInput()" type="button" class="btn btn-success">选择图片</button>
		            <!--<button class="uploadFileButton" onclick="triggerInput()">选择图片</button>-->
		        </div>
		    </section>
		</script>
		<style>
    label{
        font-weight: normal;
    }
    .form-horizontal .control-label{
        width: 35%;
    }
    .uploadFileButton{
        width: 90px;
        color: #0069d9;
        height: 25px;
        background: #2ecc71;
        border: 1px solid lightgrey;
        border-radius: 10px;
    }
    #imgPreview {
        width: 90px;
        height: 90px;
        margin: 5px auto 0px 0px;
        border: 1px solid lightgrey;
        text-align: center;
    }
    #imgSpan {
        margin: auto;
    }
    #imgUrl {
        height: 100%;
        width: 100%;
        display: none;
    }
</style>
<script>
    function triggerInput() {
        $("#file").click();
    }
    function getPic() {
        let imagePath = $("#file").val();
        if(imagePath == ""){
            $("#imgSpan").css("display","block");
            $("#imgUrl").attr("src","");
            $("#imgUrl").css("display","none");
        }else {
            let reader = new FileReader();
            reader.readAsDataURL(document.getElementById("file").files[0]);
            reader.onload = function(){
                $("#imgUrl").attr("src",this.result);
            }
            $("#imgSpan").css("display","none");
            $("#imgUrl").css("display","block");


            let formData = new FormData();
            formData.append("file",$("#file")[0].files[0]);
           $.ajax({
                type:"post",
                url:"http://222.182.202.100:7788/api/file/upload?appId=888",
                data:formData,
                contentType:false,
                processData:false,
                success:function (res) {
                    $.hide_overall_loding();
                    if(res.code == 0){
                    	$("#imgUrlAdd").attr("value",res.data.filePath);
                    }else{
                        layer.msg("操作失败", {icon: 2});
                    }
                },
                fail:function () {
                    layer.msg("操作失败", {icon: 2});
                }
            })
        }
    }

</script>

	</body>

</html>
