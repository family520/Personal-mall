<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="../images/logoIcon.png" type="image/icon"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <title>中国工业互联网研究院测试中心</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/materialdesignicons.min.css" rel="stylesheet">
    <link href="../css/style.min.css" rel="stylesheet">
    <link href="../css/bootstrap-treeview.css" rel="stylesheet">
    <link href="../css/commonStyle.css" rel="stylesheet">
    <link href="../css/layui.css" rel="stylesheet"/>
    <link href="../plus/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../plus/iview/iview.css"/>

    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../plus/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="../plus/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="../plus/layer/layer.js"></script>
    <script src="../js/template-web.js"></script>
    <script src="../js/bootstrap-treeview.js"></script>
    <script src="../js/httpUtils.js"></script>
    <script src="../plus/iview/vue.min.js"></script>
    <script src="../plus/iview/iview.min.js"></script>
</head>

<body style="background: #f5f6fa;">
<div id="hander">
    <script>
        $(function () {
            $("#hander").load("handMenu.html");
        });
    </script>
</div>
<main class="lyear-layout-content" style="display: none">
    <iframe src="" id="ifr" width="100%" height="99%" frameborder="0" scrolling="no"></iframe>
</main>

<script>
    // 请求3D地址
    $.ajax({
        url: addToUrlToken(deviceServiceUrl + "/platformparam/list"),
        type: "get",
        contentType: "application/json",
        dataType: "json",
        timeout: 10000,
        data: {"platformType": 4},
        async: false,
        success: function (data) {
            plan_3D_url = data.data[0].url_3d;;
        }
    });
    // 请求3D的service_key和service_id
    $.ajax({
        url: addToUrlToken(deviceServiceUrl + "/platformparam/list"),
        type: "get",
        contentType: "application/json",
        dataType: "json",
        timeout: 10000,
        data: {"platformType": 1},
        async: false,
        success: function (data) {
            service_id = data.data[0].serviceId;
            service_key = data.data[0].serviceKey;
            call_back_url = data.data[0].callBackUrl;
        }
    });

    var token = getToken();
    var url = plan_3D_url + "/otheAPI/openDesign1";
    url += "?user_token=" + token;
    $("#ifr").attr("src", url);

    function changeFrameHeight() {
        var ifm = document.getElementById("ifr");
        ifm.height = document.documentElement.clientHeight - 70;
    }

    window.onresize = function () {
        changeFrameHeight();
    }

    $(function () {
        changeFrameHeight();
    });

    var modeControlData = {};

    //监听3D模型
    window.addEventListener('message', function (e) {
        console.info("=============================");
        console.info(e);
        var data = e.data;
        if (data.type == "saveplan") {  // 保存模式
            // 获取模式名字
            var modeName = data.plan_data.fa_mc;
            var _data = {
                modeName: modeName,
                modeControl: modeControlData
            };
            $.postJSON(deviceServiceUrl + "/exeutionPlan/local/addMode", _data, function (res) {
                // console.info(res);
                if (res.code == 0) {
                    var _data = {
                        user_token: getToken(),
                        dataStr: data.plan_data,
                        mszh_id: res.data
                    };
                    $.ajax({
                        url: plan_3D_url + "/otheAPI/otherSaveFA",
                        type: "post",
                        contentType: "application/json",
                        dataType: "json",
                        data: JSON.stringify(_data),
                        async: false,
                        success: function (res) {
                            console.info(res);
                            if (res.status == 200) {
                                layer.msg("创建模式成功！", {icon: 1});
                            } else {

                            }
                        }
                    });
                }
            });
        }
        if (data.type == "control") {   // 打开控制模板
            var url = deviceServiceUrl + "/typeTemplate/getTemplate?mac=" + data.serial_num + "&templateType=3";
            $.ajax({
                url: url,
                type: "get",
                contentType: "application/json",
                dataType: "json",
                timeout: 10000,
                success: function (res) {
                    // console.info('获取模板成功。。。');
                    // console.info(res);
                    if (res.code == 0 && res.data != null) {
                        var layer3D = layer.open({
                            type: 1,
                            skin: 'card', //自定义样式winning-class
                            title: "控制",
                            area: ['800px', '600px'],
                            offset: 'auto', //居中
                            zIndex: layer.zIndex,
                            content: '<iframe src="" id="modeIfr" name="modeIfr" frameborder="0" scrolling="no"' +
                            ' style="min-height: 400px;width: 100%;height: 98%;"></iframe>',
                            success: function () {
                                document.getElementById("modeIfr").srcdoc = res.data;
                                $("#modeIfr").load(function () {
                                    $("#modeIfr").contents().find(".sendControlBtn").unbind();
                                    $("#modeIfr").contents().find(".sendControlBtn").on("click", function () {
                                        var datas = $("#modeIfr")[0].contentWindow.getCmdParams($(this));
                                        console.info(datas);
                                        if (!datas) {
                                            layer.msg("操作失败", {icon: 2});
                                            return false;
                                        }
                                        if (datas.controlParams) {
                                            datas.controlParams = JSON.stringify(datas.controlParams);
                                        }
                                        if (!datas.operation) {
                                            layer.msg("操作失败", {icon: 2});
                                            return false;
                                        }
                                        modeControlData[data.serial_num] = datas;
                                        /*$.extend(datas, {
                                            account: one.deviceSubscriberNumber,
                                            serial_num: one.deviceMac,
                                            productId: one.productCode
                                        })*/
                                    });
                                });
                            }
                        });
                    } else {
                        layer.msg("获取模板失败！", {icon: 5});
                    }
                }
            });
        }
        if (data.type == "modectrl") {
            var u = addToUrlToken(deviceServiceUrl + "/mode/controlMode");
            u += "&id=" + data.mszh_id;
            $.ajax({
                url: u,
                type: "post",
                contentType: "application/json",
                dataType: "json",
                timeout: 60000,
                success: function (res) {
                    if (res.code == 0) {
                        layer.msg("控制成功！", {icon: 1});
                    }
                }
            });
        }
    });
</script>
</body>
</html>